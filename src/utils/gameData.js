/**
 * Game Data - Text prompts
 * 
 * Structure:
 * {
 *   promptId: string,
 *   prompt: string, // Text prompt shown to all players
 *   blankPosition: number, // Which line has the blank
 *   difficulty: 'easy' | 'medium' | 'hard'
 * }
 */

export const textPrompts = [
  {
    promptId: '1',
    prompt: 'I knew our plans for robbing the bank were bad when Dale came out wearing ____.',
    difficulty: 'easy'
  },
  {
    promptId: '2',
    prompt: 'The teacher paused the class after discovering ____ inside their desk.',
    difficulty: 'easy'
  },
  {
    promptId: '3',
    prompt: 'Our family reunion always comes to a crashing halt every time grandma mentions ____.',
    difficulty: 'easy'
  },
  {
    promptId: '4',
    prompt: 'The rule was clear: no ____ after midnight.',
    difficulty: 'easy'
  },
  {
    promptId: '5',
    prompt: 'The instructions for feeding the dog seemed simple, except the part about ____.',
    difficulty: 'easy'
  },
  {
    promptId: '6',
    prompt: 'Nobody expected our business meeting to turn into a discussion about ____.',
    difficulty: 'easy'
  },
  {
    promptId: '7',
    prompt: 'Superman’s other secret weakness turned out to be ____.',
    difficulty: 'easy'
  },
  {
    promptId: '8',
    prompt: 'I realized I was underprepared when my go bag contained only ____.',
    difficulty: 'easy'
  },
  {
    promptId: '9',
    prompt: 'The house sign warned visitors to beware of ____.',
    difficulty: 'easy'
  },
  {
    promptId: '10',
    prompt: 'My 4th grade science experiment failed immediately due to an unexpected ____.',
    difficulty: 'easy'
  },
  {
    promptId: '11',
    prompt: 'My confidence disappeared the moment I heard my mom say ____.',
    difficulty: 'easy'
  },
  {
    promptId: '12',
    prompt: 'Mom’s secret recipe called for flour, sugar, and a surprising amount of ____.',
    difficulty: 'easy'
  },
  {
    promptId: '13',
    prompt: 'The vacation was perfect until we encountered dad with ____.',
    difficulty: 'easy'
  },
  {
    promptId: '14',
    prompt: 'The manual specifically said never to cross the red wire with the blue one because ____.',
    difficulty: 'easy'
  },
  {
    promptId: '15',
    prompt: 'Everyone applauded during my solo because ____.',
    difficulty: 'easy'
  },
  {
    promptId: '16',
    prompt: 'The new company policy exists entirely because Joe ____.',
    difficulty: 'easy'
  },
  {
    promptId: '17',
    prompt: 'The mystery of the missing child was solved when detectives found ____.',
    difficulty: 'easy'
  },
  {
    promptId: '18',
    prompt: 'The Christmas parade came to a halt after ____ rolled down the street.',
    difficulty: 'easy'
  },
  {
    promptId: '19',
    prompt: 'My alarm went off, but it was just reminding me ____.',
    difficulty: 'easy'
  },
  {
    promptId: '20',
    prompt: 'The job interview was going well until they asked me about ____.',
    difficulty: 'easy'
  },
  {
    promptId: '21',
    prompt: 'The inventor insisted the time machine would work if we just added ____.',
    difficulty: 'easy'
  },
  {
    promptId: '22',
    prompt: 'Game night ended early after ____ was introduced.',
    difficulty: 'easy'
  },
  {
    promptId: '23',
    prompt: 'Grandpa’s apology sounded sincere until he mentioned ____.',
    difficulty: 'easy'
  },
  {
    promptId: '24',
    prompt: 'The wizard’s spell backfired and summoned ____.',
    difficulty: 'easy'
  },
  {
    promptId: '25',
    prompt: 'The meeting agenda somehow included ____ twice.',
    difficulty: 'easy'
  },
  {
    promptId: '26',
    prompt: 'I trusted the plan until someone whispered ____.',
    difficulty: 'easy'
  },
  {
    promptId: '27',
    prompt: 'The museum exhibit was shut down after my sister ____.',
    difficulty: 'easy'
  },
  {
    promptId: '28',
    prompt: 'My dad’s new invention promised convenience but delivered ____.',
    difficulty: 'easy'
  },
  {
    promptId: '29',
    prompt: 'The party theme made sense once we saw ____.',
    difficulty: 'easy'
  },
  {
    promptId: '30',
    prompt: 'The coach’s motivational speech focused heavily on ____.',
    difficulty: 'easy'
  },
  {
    promptId: '31',
    prompt: 'The family road trip became unforgettable thanks to ____.',
    difficulty: 'easy'
  },
  {
    promptId: '32',
    prompt: 'The instructions warned users not to stare directly at ____.',
    difficulty: 'easy'
  },
  {
    promptId: '33',
    prompt: 'The detective raised an eyebrow after finding ____.',
    difficulty: 'easy'
  },
  {
    promptId: '34',
    prompt: 'Dad’s surprise birthday party was ruined when mom ____.',
    difficulty: 'easy'
  },
  {
    promptId: '35',
    prompt: 'The talent show judge was speechless after I ____.',
    difficulty: 'easy'
  },
  {
    promptId: '36',
    prompt: 'The secret ingredient in my wife\'s special casserole turned out to be ____.',
    difficulty: 'easy'
  },
  {
    promptId: '37',
    prompt: 'The plan sounded reasonable until Bill required ____.',
    difficulty: 'easy'
  },
  {
    promptId: '38',
    prompt: 'The touchdown celebration stopped abruptly due to ____.',
    difficulty: 'easy'
  },
  {
    promptId: '39',
    prompt: 'They put a warning label on milk because someone once tried ____.',
    difficulty: 'easy'
  },
  {
    promptId: '40',
    prompt: 'The invention worked perfectly, provided you only have one ____.',
    difficulty: 'easy'
  },
  {
    promptId: '41',
    prompt: 'The wedding announcement caused confusion when it mentioned ____.',
    difficulty: 'easy'
  },
  {
    promptId: '42',
    prompt: 'The room went silent after I farted. It’s all good though, because I blamed it on ____.',
    difficulty: 'easy'
  },
  {
    promptId: '43',
    prompt: 'The presentation included charts, graphs, and ____.',
    difficulty: 'easy'
  },
  {
    promptId: '44',
    prompt: 'The costume was impressive, but the ____ made it unforgettable.',
    difficulty: 'easy'
  },
  {
    promptId: '45',
    prompt: 'My magic trick failed when ____ fell out.',
    difficulty: 'easy'
  },
  {
    promptId: '46',
    prompt: 'The Nebraska guidebook strongly discouraged ____.',
    difficulty: 'easy'
  },
  {
    promptId: '47',
    prompt: 'The baby celebration became awkward once ____ was revealed.',
    difficulty: 'easy'
  },
  {
    promptId: '48',
    prompt: 'My first day on the job ended early after my new boss ____.',
    difficulty: 'easy'
  },
  {
    promptId: '49',
    prompt: 'Mom paused dramatically before revealing Dad had ____.',
    difficulty: 'easy'
  },
  {
    promptId: '50',
    prompt: 'On my 10th birthday, I received a surprise gift that turned out to be ____.',
    difficulty: 'easy'
  },
  {
    promptId: '51',
    prompt: 'The weightlifting competition was cancelled after ____.',
    difficulty: 'easy'
  },
  {
    promptId: '52',
    prompt: 'The school announcement made sense, except for the part about my teacher now ____.',
    difficulty: 'easy'
  },
  {
    promptId: '53',
    prompt: 'My checkers strategy relies heavily on ____.',
    difficulty: 'easy'
  },
  {
    promptId: '54',
    prompt: 'The discovery of the dead body shocked everyone, especially ____.',
    difficulty: 'easy'
  },
  {
    promptId: '55',
    prompt: 'Grandpa’s birthday celebration included cake, music, and his favorite ____.',
    difficulty: 'easy'
  },
  {
    promptId: '56',
    prompt: 'The tornado warning came too late, I was in the middle of ____.',
    difficulty: 'easy'
  },
  {
    promptId: '57',
    prompt: 'The science experiment’s unexpected result was ____.',
    difficulty: 'easy'
  },
  {
    promptId: '58',
    prompt: 'The new rule at work was created to prevent me from ____.',
    difficulty: 'easy'
  },
  {
    promptId: '59',
    prompt: 'The meeting room smelled strongly of ____.',
    difficulty: 'easy'
  },
  {
    promptId: '60',
    prompt: 'The magician blamed the failure on ____.',
    difficulty: 'easy'
  },
  {
    promptId: '61',
    prompt: 'The adventure truly began once we found ____.',
    difficulty: 'easy'
  },
  {
    promptId: '62',
    prompt: 'The conversation with mom took a turn when ____ was mentioned.',
    difficulty: 'easy'
  },
  {
    promptId: '63',
    prompt: 'The instructions for watching our neighbor’s dog ended with a note about ____.',
    difficulty: 'easy'
  },
  {
    promptId: '64',
    prompt: 'The invention of goggles gained popularity despite ____.',
    difficulty: 'easy'
  },
  {
    promptId: '65',
    prompt: 'The funeral service ended when ____ ran out.',
    difficulty: 'easy'
  },
  {
    promptId: '66',
    prompt: 'The team agreed the plan depended entirely on ____.',
    difficulty: 'easy'
  },
  {
    promptId: '67',
    prompt: 'The warning sign featured a picture of ____.',
    difficulty: 'easy'
  },
  {
    promptId: '68',
    prompt: 'The school play received a standing ovation for ____.',
    difficulty: 'easy'
  },
  {
    promptId: '69',
    prompt: 'The discovery of the remains raised more questions about ____.',
    difficulty: 'easy'
  },
  {
    promptId: '70',
    prompt: 'The celebration paused briefly for ____ before going late into the night.',
    difficulty: 'easy'
  },
  {
    promptId: '71',
    prompt: 'I had to take the bus because my car ____.',
    difficulty: 'easy'
  },
  {
    promptId: '72',
    prompt: 'The vacation memory everyone remembers about me involves ____.',
    difficulty: 'easy'
  },
  {
    promptId: '73',
    prompt: 'I walked here simply to spite ____.',
    difficulty: 'easy'
  },
  {
    promptId: '74',
    prompt: 'I caught grandma reading ____.',
    difficulty: 'easy'
  },
  {
    promptId: '75',
    prompt: 'The lesson was finally learned after dad slipped on ____ for the third time.',
    difficulty: 'easy'
  },
  {
    promptId: '76',
    prompt: 'The instructions on the frozen waffles included a note about ____.',
    difficulty: 'easy'
  },
  {
    promptId: '77',
    prompt: 'The surprise made sense once we saw ____.',
    difficulty: 'easy'
  },
  {
    promptId: '78',
    prompt: 'The team celebrated by sharing my ____.',
    difficulty: 'easy'
  },
  {
    promptId: '79',
    prompt: 'My plan to lose weight requires courage, teamwork, and ____.',
    difficulty: 'easy'
  },
  {
    promptId: '80',
    prompt: 'The wedding announcement concluded with a warning about ____.',
    difficulty: 'easy'
  },
  {
    promptId: '81',
    prompt: 'The shooting competition featured speed, skill, and ____.',
    difficulty: 'easy'
  },
  {
    promptId: '82',
    prompt: 'I have friends that no one knows about, including ____.',
    difficulty: 'easy'
  },
  {
    promptId: '83',
    prompt: 'My birthday party ended when ____ arrived unexpectedly.',
    difficulty: 'easy'
  },
  {
    promptId: '84',
    prompt: 'My arrival at the pool caused excitement and ____.',
    difficulty: 'easy'
  },
  {
    promptId: '85',
    prompt: 'My college journey took an unexpected detour due to ____.',
    difficulty: 'easy'
  },
  {
    promptId: '86',
    prompt: 'I saw my doctor’s notes about me and they highlighted concerns about ____.',
    difficulty: 'easy'
  },
  {
    promptId: '87',
    prompt: 'My wife’s birthday celebration included balloons, music, and ____.',
    difficulty: 'easy'
  },
  {
    promptId: '88',
    prompt: 'The plan changed dramatically after ____.',
    difficulty: 'easy'
  },
  {
    promptId: '89',
    prompt: 'The discovery explained everything except ____.',
    difficulty: 'easy'
  },
  {
    promptId: '90',
    prompt: 'The adventure was remembered mostly for ____.',
    difficulty: 'easy'
  },
  {
    promptId: '91',
    prompt: 'The surprise announcement focused on ____.',
    difficulty: 'easy'
  },
  {
    promptId: '92',
    prompt: 'The experiment’s conclusion mentioned ____.',
    difficulty: 'easy'
  },
  {
    promptId: '93',
    prompt: 'The plan to steal candy from the baby succeeded despite ____.',
    difficulty: 'easy'
  },
  {
    promptId: '94',
    prompt: 'The party theme became clear once ____ appeared.',
    difficulty: 'easy'
  },
  {
    promptId: '95',
    prompt: 'The invention of the internet was revolutionary because now ____.',
    difficulty: 'easy'
  },
  {
    promptId: '96',
    prompt: 'The meeting with my banker ended early because ____.',
    difficulty: 'easy'
  },
  {
    promptId: '97',
    prompt: 'The journey was long, tiring, and full of ____.',
    difficulty: 'easy'
  },
  {
    promptId: '98',
    prompt: 'The discovery of the onion in my salad sparked  ____.',
    difficulty: 'easy'
  },
  {
    promptId: '99',
    prompt: 'The celebration paused when a wheelchair  ____.',
    difficulty: 'easy'
  },
  {
    promptId: '100',
    prompt: 'The bedtime story ends with a lesson about ____.',
    difficulty: 'easy'
  }
];

const RECENT_PROMPTS_STORAGE_KEY = 'pp_recent_prompt_ids';
const MAX_RECENT_PROMPTS = 20;

const loadRecentPromptIds = () => {
  if (typeof window === 'undefined' || !window.localStorage) return [];
  try {
    const raw = window.localStorage.getItem(RECENT_PROMPTS_STORAGE_KEY);
    const parsed = JSON.parse(raw || '[]');
    return Array.isArray(parsed) ? parsed.filter(Boolean) : [];
  } catch (error) {
    return [];
  }
};

const storeRecentPromptId = (promptId) => {
  if (typeof window === 'undefined' || !window.localStorage || !promptId) return;
  try {
    const recent = loadRecentPromptIds().filter((id) => id !== promptId);
    const updated = [promptId, ...recent].slice(0, MAX_RECENT_PROMPTS);
    window.localStorage.setItem(RECENT_PROMPTS_STORAGE_KEY, JSON.stringify(updated));
  } catch (error) {
    // Ignore storage errors (private mode, blocked storage, etc.)
  }
};

const getRandomIndex = (max) => {
  if (max <= 1) return 0;
  if (typeof window !== 'undefined' && window.crypto?.getRandomValues) {
    const maxUint32 = 0xffffffff;
    const limit = Math.floor(maxUint32 / max) * max;
    const buffer = new Uint32Array(1);
    let value = 0;
    do {
      window.crypto.getRandomValues(buffer);
      value = buffer[0];
    } while (value >= limit);
    return value % max;
  }
  return Math.floor(Math.random() * max);
};

export const getRandomPrompt = (difficulty = null, usedPromptIds = []) => {
  let availablePrompts = textPrompts;
  const recentPromptIds = loadRecentPromptIds();
  const excludedPromptIds = new Set([...(usedPromptIds || []), ...recentPromptIds]);

  if (excludedPromptIds.size > 0) {
    availablePrompts = availablePrompts.filter((prompt) => !excludedPromptIds.has(prompt.promptId));
  }

  if (difficulty) {
    availablePrompts = availablePrompts.filter((prompt) => prompt.difficulty === difficulty);
  }

  if (availablePrompts.length === 0) {
    availablePrompts = difficulty
      ? textPrompts.filter((prompt) => prompt.difficulty === difficulty)
      : textPrompts;
    if (usedPromptIds && usedPromptIds.length > 0) {
      availablePrompts = availablePrompts.filter(
        (prompt) => !usedPromptIds.includes(prompt.promptId)
      );
    }
  }

  const randomIndex = getRandomIndex(availablePrompts.length);
  const selectedPrompt = availablePrompts[randomIndex];
  if (selectedPrompt?.promptId) {
    storeRecentPromptId(selectedPrompt.promptId);
  }
  return selectedPrompt;
};

